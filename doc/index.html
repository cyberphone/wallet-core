<!DOCTYPE html>
<html lang='en'>
<head>
  <link rel='icon' href='webpkiorg.png' sizes='192x192'>
  <meta name='viewport' content='initial-scale=1.0'>
  <meta charset='UTF-8'>
  <title>Wallet Core</title>
  <link rel='stylesheet' type='text/css' href='style.css'>
</head>
<body>
<h3 style="text-align:center;font-weight:normal;font-size:1.5em">Saturn - Payment Authorization Wallet</h3>
<i>Disclaimer: this is a system in development, subject to change without notice.</i>
<p>
Copyright Notice: this document is furnished under the <a href='../LICENSE'>MIT license</a>.
</p>
<h3>Table of Contents</h3>
<div class='webpkifloat'><div>
<div style='padding-left:2em'><a href='#1.introduction'>1.&nbsp; Introduction</a></div><div style='padding-left:2em'><a href='#2.detailed-operation'>2.&nbsp; Detailed&nbsp;Operation</a></div><div style='padding-left:4em'><a href='#2.1.wallet-initiation'>2.1.&nbsp; Wallet&nbsp;Initiation</a></div><div style='padding-left:4em'><a href='#2.2.wallet-request-ui'>2.2.&nbsp; Wallet&nbsp;Request&nbsp;UI</a></div><div style='padding-left:4em'><a href='#2.3.payer-authorization'>2.3.&nbsp; Payer&nbsp;Authorization</a></div><div style='padding-left:4em'><a href='#2.4.wallet-termination'>2.4.&nbsp; Wallet&nbsp;Termination</a></div><div style='padding-left:2em'><a href='#3.message-reference'>3.&nbsp; Message&nbsp;Reference</a></div><div style='padding-left:4em'><a href='#3.1.authorization-request'>3.1.&nbsp; Authorization&nbsp;Request</a></div><div style='padding-left:4em'><a href='#3.2.authorization-response'>3.2.&nbsp; Authorization&nbsp;Response</a></div><div style='padding-left:4em'><a href='#3.3.pass-through-data'>3.3.&nbsp; &quot;Pass&nbsp;Through&quot;&nbsp;Data</a></div><div style='padding-left:4em'><a href='#3.4.payment-request'>3.4.&nbsp; Payment&nbsp;Request</a></div><div style='padding-left:4em'><a href='#3.5.provider-data'>3.5.&nbsp; Provider&nbsp;Data</a></div><div style='padding-left:4em'><a href='#3.6.signed-authorization'>3.6.&nbsp; Signed&nbsp;Authorization</a></div><div style='padding-left:2em'><a href='#4.credential-database'>4.&nbsp; Credential&nbsp;Database</a></div><div style='padding-left:2em'><a href='#5.authorization-processing'>5.&nbsp; Authorization&nbsp;Processing</a></div><div style='padding-left:4em'><a href='#5.1.decryption'>5.1.&nbsp; Decryption</a></div><div style='padding-left:4em'><a href='#5.2.signature-validation'>5.2.&nbsp; Signature&nbsp;Validation</a></div><div style='padding-left:2em'><a href='#6.test-vectors'>6.&nbsp; Test&nbsp;Vectors</a></div><div style='padding-left:2em'><a href='#7.version'>7.&nbsp; Version</a></div>
</div></div>
<h3 id='1.introduction'>1.&nbsp; Introduction</h3>
This document describes the core components of the Saturn wallet.
Note that Saturn is a <i>payment authorization </i> system for end-users,
not a payment system.  Saturn is heavily influenced by the current
&quot;gold&nbsp;standard&quot; for consumer payments, <a href='https://www.emvco.com/'>EMV<img src='xtl.svg' alt='emv'></a>.
<p style='padding-bottom:0;margin-bottom:0'>
Compared to EMV, Saturn introduces several enhancements:
</p>
<ul style='padding-top:0;margin-top:0'>
  <li style='padding-top:0.5em'>For privacy reasons user authorizations are <i>encrypted</i>.</li>
  <li>Intended to work with <i>any</i> account-based payment system.</li>
  <li>Eliminates specific on-line solutions like 3D Secure.</li>
  <li>Receipt option.</li>
  <li>Account balance option.</li>
  <li>Built-in support for authorization of non-direct payments.</li>
</ul>
<p>
Saturn builds on the idea that different payment networks should not
need unique user authorizations solutions; only identifiers
related to accounts and payment networks need to be adapted.
This data is provided in the associated virtual payment cards (payment credentials),
potentially making the wallet software <i>universal</i>.
</p>
The sequence diagram below outlines the Saturn protocol: 
<div class='webpkifloat'><img src='sequence-diagram.png' class='webpkibox' style='width:50em' title='Sequence Diagram'></div>
<h3 id='2.detailed-operation'>2.&nbsp; Detailed&nbsp;Operation</h3>
To guide the reader, this document is based on an example which
in turn provides links to the formal definitions.
<p>
The Saturn protocol is based on CBOR [<a href='https://www.rfc-editor.org/rfc/rfc8949.html'>RFC8949<img src='xtl.svg' alt='rfc8949'></a>] which is a <i>binary</i> interchange format.
However, for documentation purposes, messages are shown in <i>diagnostic notation</i>.
</p>
To support cryptographic operations requiring secure transformations of CBOR <code>map</code> objects,
Saturn relies on an IETF standard currently in development [<a href='https://datatracker.ietf.org/doc/draft-ietf-cbor-cde/'>CDE<img src='xtl.svg' alt='cde'></a>],
which defines <i>deterministic encoding</i> of CBOR.
<h5 id='2.1.wallet-initiation'>2.1.&nbsp; Wallet&nbsp;Initiation</h5>
The payment process is initiated when the <code class='entity'>Payer</code> hits a &quot;Pay&quot;
button on the Web or scans a QR-code, returning a <code class='entity'>Wallet</code> activation URL.
The <code class='entity'>Wallet</code> should then use the received URL for performing an HTTP&nbsp;GET
(step #1 in the sequence diagram) to the <code class='entity'>Payee</code> service.
This operation should return an <a href='#3.1.authorization-request'>Authorization&nbsp;Request</a> object
(step #2 in the sequence diagram) like the following:
<div class='webpkifloat'><div class='webpkibox' id='authz-req.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;722385402&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;EUR&quot;<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;2:&nbsp;[&quot;https://cardnetwork.com&quot;,&nbsp;&quot;https://banknet2.org&quot;]<br>}</div></div>
Note that the <code class='entity'>Payee</code> service <b>must</b> set the
HTTP <code style='white-space:nowrap'>Content-Type</code> header parameter
to <code>application/cbor</code>.
<h5 id='2.2.wallet-request-ui'>2.2.&nbsp; Wallet&nbsp;Request&nbsp;UI</h5>
After receival of the <a href='#3.1.authorization-request'>Authorization&nbsp;Request</a>,
the <code class='entity'>Wallet</code> should display a UI like the following:
<div class='webpkifloat'><img src='wallet-ui.svg' style='padding:0;width:28em' class='webpkibox'  title='Wallet UI'></div>
If there are multiple <a href='#4.credential-database'>Credential&nbsp;Database</a> entries
matching the <code class='entity'>Payee</code>
request, the <code class='entity'>Payer</code> needs
to select (step #3 in the sequence diagram) a suitable
credential, unless the default (or last used) credential already meet
the preferences of the <code class='entity'>Payer</code>.
<p>
If there are no matching payment credentials, the <code class='entity'>Wallet</code>
<b>must</b> provide the <code class='entity'>Payer</code> with
a suitable error message and a cancel button. 
</p>
<h5 id='2.3.payer-authorization'>2.3.&nbsp; Payer&nbsp;Authorization</h5>
Assuming that the <code class='entity'>Payer</code> accepts and subsequently authorizes 
the request (step #4 in the sequence diagram),
the <code class='entity'>Wallet</code> should perform an HTTP&nbsp;POST
(step #5 in the sequence diagram)
to the <code class='entity'>Payee</code> service containing an
<a href='#3.2.authorization-response'>Authorization&nbsp;Response</a>
object like the following: 
<div class='webpkifloat'><div class='webpkibox' id='authz-res.txt' style='width:50em'>1010([&quot;https://saturn.standard/v4&quot;,&nbsp;{<br>&nbsp;&nbsp;0:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;722385402&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;EUR&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;mybank.com&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;1:&nbsp;3,<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-29,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3:&nbsp;h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;7:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'50ae6495cfa2f6435399d539a3f7a3d70a88bc7f4f1afc2d883db1065d9eaf72',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3:&nbsp;h'cab412ef81ae3de2136acfd76f7baa3de0c07f8adc391592942f56ff3275088a'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;10:&nbsp;h'44b042d6bcc12894ea05ae4cf23d80ec27535a3d29a07e4f45681693d51e6747c98bac3652d4d28c'<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;8:&nbsp;h'384be551cc8fda4803ef9e150207b148',<br>&nbsp;&nbsp;9:&nbsp;h'957d107139b2770a23e7b38c',<br>&nbsp;&nbsp;10:&nbsp;h'f68500a09170113896bb34cfb64785705729da5b6ad64659efd026f291f74ef0e82f663ad0563807b6da62d86608811febe1bdb2269fe9d06714cf39c2a4c4062e7cb9d643212cdf1c9d9a0b2b2c8b92941a96261b3d2858601086e0e8e64faba6d67ee3e7df534704979977b713a49a918efbb420dbfda022144d299b404295d2efb9ea83658fa35741275ce652f3a1963906f59e17db1f0862b54eb921b99afcf811be22caf2bd61226ed98daae2d81abe66a9b2baa982c9c60a5f8796ace4361a6b51749e2811f7401ec6fc5af7c60ec7ac452a58ff255c5236d16dd15ae619790efafb1b9c20beacfee849e875f9e568b355f58ce89e'<br>}])</div></div>
Note that the POST <b>must</b> be directed to the same URL as
used by the GET in <a href='#2.1.wallet-initiation'>Wallet&nbsp;Initiation</a>.
In addition, the HTTP <code style='white-space:nowrap'>Content-Type</code>
header parameter <b>must</b> be set to <code>application/cbor</code>.
<h5 id='2.4.wallet-termination'>2.4.&nbsp; Wallet&nbsp;Termination</h5>
After successful (or failed) authorization, the 
<a href='#3.2.authorization-response'>Authorization&nbsp;Response</a>
should return a <code class='entity'>Wallet</code> termination
message (step #6 in the sequence diagram).
This message depends on how the payment process was initiated,
and is currently TBD.
<h3 id='3.message-reference'>3.&nbsp; Message&nbsp;Reference</h3>
This section contains a reference to the components underpinning Saturn messages.
The components are based on CBOR <code>map</code> objects.
<h5 id='3.1.authorization-request'>3.1.&nbsp; Authorization&nbsp;Request</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Label</th><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td style='text-align:center'><code>1</code></td><td><kbd>paymentRequest</kbd></td><td style='text-align:center'><code>map</code></td><td>Holds the <a href='#3.4.payment-request'>Payment&nbsp;Request</a> object.</td></tr><tr><td style='text-align:center'><code>2</code></td><td><kbd>supportedNetworks</kbd></td><td style='text-align:center'><code>array</code></td><td>Holds a non-empty list of payment network/method identifiers that the <code class='entity'>Payee</code> supports. Network identifiers are expressed as CBOR strings (tstr).<div style='padding-top:0.5em'>See also <kbd>networkId</kbd> in <a href='#4.credential-database'>Credential&nbsp;Database</a>.</div></td></tr></table></div>The Authorization Request represents the core <code class='entity'>Payee</code> to <code class='entity'>Wallet</code> message. In same-device Web contexts this message is also associated with the invocation of the <code class='entity'>Wallet</code>.
<h5 id='3.2.authorization-response'>3.2.&nbsp; Authorization&nbsp;Response</h5>An Authorization Response consists of a single <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/encryption.html'>CEF<img src='xtl.svg' alt='cef'></a> object, where the outermost element is a <a href='https://www.ietf.org/archive/id/draft-rundgren-cotx-04.html'>COTX<img src='xtl.svg' alt='cotx'></a> wrapper with ID=<code>https://saturn.standard/v4</code>.  The CEF inner elements are as follows:<div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Label</th><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td style='text-align:center'><code>0</code></td><td><kbd>customData</kbd></td><td style='text-align:center'><code>map</code></td><td>CEF: custom (<i>unencrypted</i>) data in the form of a copy of the <a href='#3.3.pass-through-data'>&quot;Pass&nbsp;Through&quot;&nbsp;Data</a> object fetched from <a href='#3.6.signed-authorization'>Signed&nbsp;Authorization</a> object.</td></tr><tr><td style='text-align:center'><code>10</code></td><td><kbd>cipherText</kbd></td><td style='text-align:center'><code>bstr</code></td><td>CEF: <i>encrypted</i> version of the <a href='#3.6.signed-authorization'>Signed&nbsp;Authorization</a> object where the <a href='#3.3.pass-through-data'>&quot;Pass&nbsp;Through&quot;&nbsp;Data</a> object has been removed <i>after</i> the completed authorization signature process.<div style='padding-top:0.5em'>Note that the modified <a href='#3.6.signed-authorization'>Signed&nbsp;Authorization</a> <code>map</code> object <b>must</b> be updated (<i>before</i> being encrypted), to reflect the removal of the <a href='#3.3.pass-through-data'>&quot;Pass&nbsp;Through&quot;&nbsp;Data</a> object.</div></td></tr></table></div>See also <a href='#5.authorization-processing'>Authorization&nbsp;Processing</a>.
<h5 id='3.3.pass-through-data'>3.3.&nbsp; &quot;Pass&nbsp;Through&quot;&nbsp;Data</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Label</th><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td style='text-align:center'><code>1</code></td><td><kbd>paymentRequest</kbd></td><td style='text-align:center'><code>map</code></td><td>Through the inclusion of a copy of the <a href='#3.4.payment-request'>Payment&nbsp;Request</a> in the <code class='entity'>Payer</code> authorization, this object remains <i>authoritative</i> throughout the payment process (except for interbank operations).</td></tr><tr><td style='text-align:center'><code>2</code></td><td><kbd>providerData</kbd></td><td style='text-align:center'><code>map</code></td><td>Holds the <a href='#3.5.provider-data'>Provider&nbsp;Data</a> required by the <code class='entity'>Payee</code> for deriving which payment network to use and initiating a compatible payment transaction request.</td></tr></table></div>
<h5 id='3.4.payment-request'>3.4.&nbsp; Payment&nbsp;Request</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Label</th><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td style='text-align:center'><code>1</code></td><td><kbd>commonName</kbd></td><td style='text-align:center'><code>tstr</code></td><td><code class='entity'>Payee</code> common name to be shown in UIs.</td></tr><tr><td style='text-align:center'><code>2</code></td><td><kbd>instanceId</kbd></td><td style='text-align:center'><code>tstr</code></td><td><code class='entity'>Payee</code> instance Id. <div style='padding-top:0.5em'>Instance Ids <b>must</b> be unique with respect to the <code class='entity'>Payee</code>.</div></td></tr><tr><td style='text-align:center'><code>3</code></td><td><kbd>amount</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Monetary amount compatible with the regular expression: <code style='white-space:nowrap'>^(0|[1-9][0-9]*)(\.[0-9]+)?$</code>. <div style='padding-top:0.5em'>Amounts <b>must&nbsp;not</b> use more decimals than is custom for prices for the specific <kbd>currency</kbd>.</div></td></tr><tr><td style='text-align:center'><code>4</code></td><td><kbd>currency</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Currency expressed in <a href='https://www.iso.org/iso-4217-currency-codes.html'>ISO4217<img src='xtl.svg' alt='iso4217'></a> <i>alphabetical</i> format.</td></tr><tr><td style='text-align:center'><code>5</code></td><td><kbd>nonDirect</kbd></td><td style='text-align:center'><code>map</code></td><td><i>Optional</i>: Non-direct payment request. TBD.</td></tr></table></div>
<h5 id='3.5.provider-data'>3.5.&nbsp; Provider&nbsp;Data</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Label</th><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td style='text-align:center'><code>1</code></td><td><kbd>networkId</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected virtual card.<div style='padding-top:0.5em'>Also see <a href='#4.credential-database'>Credential&nbsp;Database</a>.</div></td></tr><tr><td style='text-align:center'><code>2</code></td><td><kbd>serviceLocator</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected virtual card.<div style='padding-top:0.5em'>Also see <a href='#4.credential-database'>Credential&nbsp;Database</a>.</div></td></tr></table></div>
<h5 id='3.6.signed-authorization'>3.6.&nbsp; Signed&nbsp;Authorization</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Label</th><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td style='text-align:center'><code>1</code></td><td><kbd>passThrough</kbd></td><td style='text-align:center'><code>map</code></td><td>Holds the <a href='#3.3.pass-through-data'>&quot;Pass&nbsp;Through&quot;&nbsp;Data</a> object.</td></tr><tr><td style='text-align:center'><code>2</code></td><td><kbd>payeeHost</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Host name or IP address of the invoking <code class='entity'>Payee</code>, derived from step #1 in the sequence diagram.</td></tr><tr><td style='text-align:center'><code>3</code></td><td><kbd>accountId</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected virtual card.<div style='padding-top:0.5em'>Also see <a href='#4.credential-database'>Credential&nbsp;Database</a>.</div></td></tr><tr><td style='text-align:center'><code>4</code></td><td><kbd>serialNumber</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected virtual card.<div style='padding-top:0.5em'>Also see <a href='#4.credential-database'>Credential&nbsp;Database</a>.</div></td></tr><tr><td style='text-align:center'><code>5</code></td><td><kbd>platformData</kbd></td><td style='text-align:center'><code>array</code></td><td>Array holding the name and version of the operating system in <code>[0]</code> and <code>[1]</code> respectively, expressed as CBOR strings (tstr).</td></tr><tr><td style='text-align:center'><code>6</code></td><td><kbd>walletData</kbd></td><td style='text-align:center'><code>array</code></td><td>Array holding the name and version of the <code class='entity'>Wallet</code> software in <code>[0]</code> and <code>[1]</code> respectively, expressed as CBOR strings (tstr).</td></tr><tr><td style='text-align:center'><code>7</code></td><td><kbd>location</kbd></td><td style='text-align:center'><code>array</code></td><td><i>Optional</i>: Array holding latitude <code>[0]</code> and longitude <code>[1]</code>, expressed as CBOR floating point values.</td></tr><tr><td style='text-align:center'><code>8</code></td><td><kbd>timeStamp</kbd></td><td style='text-align:center'><code>tstr</code></td><td>ISO date-time string [<a href='https://www.rfc-editor.org/rfc/rfc3339'>RFC3339<img src='xtl.svg' alt='rfc3339'></a>] using UTC (T) or local time (Z) format.</td></tr><tr><td style='text-align:center'><code>-1</code></td><td><kbd>signature</kbd></td><td style='text-align:center'><code>map</code></td><td>Authorization signature.</td></tr></table></div>For an example, see <a href='#5.2.signature-validation'>Signature&nbsp;Validation</a>.
<h3 id='4.credential-database'>4.&nbsp; Credential&nbsp;Database</h3>
A fundamental part of the <code class='entity'>Wallet</code> is a local database holding
enrolled payment credentials.
Note that although credential data types are expressed as CBOR,
other representations may be used.
The only requirement is that credential data types can be securely
mapped back and forth to CBOR.
<p style='margin-bottom:0.5em;padding-bottom:0'>
Each entry in the database contains a payment credential according
to the following definition:
</p>
<div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>networkId</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Payment network/method identifier. Since payment networks are likely to continue having unique message solutions, the <code class='entity'>Payee</code> needs to identify the specific network before making a transaction request.<div style='padding-top:0.5em'>Payment network identifiers may be expressed as URLs or as simple names like "VISA".  Note that this concept does not make a distinction between payment methods or "schemes".</div><div style='padding-top:0.5em'>Also see <a href='#3.5.provider-data'>Provider&nbsp;Data</a>.</div></td></tr><tr><td><kbd>serviceLocator</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Payment service URL or host name. This attribute enables the <code class='entity'>Payee</code> to find the end-point of the specific payment service (like a bank), associated with the payment credential.<div style='padding-top:0.5em'>How to interpret this attribute is dictated by the <kbd>networkId</kbd> identifier. If <kbd>serviceLocator</kbd> is expressed as a host-name only, a <code style='white-space:nowrap'>&quot;.well-known&quot;</code> [<a href='https://www.rfc-editor.org/rfc/rfc8615'>RFC8615<img src='xtl.svg' alt='rfc8615'></a>] extension would typically be used.</div><div style='padding-top:0.5em'>Also see <a href='#3.5.provider-data'>Provider&nbsp;Data</a>.</div></td></tr><tr><td><kbd>accountId</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Account identifier associated with the virtual card.<div style='padding-top:0.5em'>Also see <a href='#3.6.signed-authorization'>Signed&nbsp;Authorization</a>.</div></td></tr><tr><td><kbd>serialNumber</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Serial number of the virtual card.<div style='padding-top:0.5em'>Also see <a href='#3.6.signed-authorization'>Signed&nbsp;Authorization</a>.</div></td></tr><tr><td><kbd>cardImage</kbd></td><td style='text-align:center'><code>bstr</code></td><td>Virtual card image. Card images are used for <code class='entity'>Payer</code> administration of <code class='entity'>Wallet</code> credentials as well as displayed in the <a href='#2.2.wallet-request-ui'>Wallet&nbsp;Request&nbsp;UI</a>. <div style='padding-top:0.5em'>Card images <b>must</b> be in <a href='https://www.w3.org/TR/SVG11/'>SVG<img src='xtl.svg' alt='svg'></a> format and tentatively having a size of <code>300&times;180</code> pixels.</div></td></tr></table></div>
<h3 id='5.authorization-processing'>5.&nbsp; Authorization&nbsp;Processing</h3>
This section describes how
<a href='#3.2.authorization-response'>Authorization&nbsp;Response</a> messages
should be processed, using the <a href='#2.3.payer-authorization'>Payer&nbsp;Authorization</a> sample and
associated <a href='#6.test-vectors'>Test&nbsp;Vectors</a> as model data.
<h5 id='5.1.decryption'>5.1.&nbsp; Decryption</h5>
Firstly, the <a href='#3.2.authorization-response'>Authorization&nbsp;Response</a>
object needs to be <i>decrypted</i> using a private key associated with the 
supplied <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/encryption.html'>CEF<img src='xtl.svg' alt='cef'></a> <kbd>publicKey</kbd> or <kbd>keyId</kbd> attribute.
In the sample, a <kbd>publicKey</kbd> attribute was used.
The decryption process should return two CBOR objects:
the <a href='#3.3.pass-through-data'>&quot;Pass&nbsp;Through&quot;&nbsp;Data</a>
object which is already supplied in clear:
<div class='webpkifloat'><div class='webpkibox' id='pass-through-data.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;722385402&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;EUR&quot;<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;mybank.com&quot;<br>&nbsp;&nbsp;}<br>}</div></div>
and another object which after decryption should read like the following:
<div class='webpkifloat'><div class='webpkibox' id='restored.txt' style='width:50em'>{<br>&nbsp;&nbsp;2:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;3:&nbsp;&quot;FR7630002111110020050014382&quot;,<br>&nbsp;&nbsp;4:&nbsp;&quot;010049255&quot;,<br>&nbsp;&nbsp;5:&nbsp;[&quot;Android&quot;,&nbsp;&quot;14.1&quot;],<br>&nbsp;&nbsp;6:&nbsp;[&quot;Saturn&quot;,&nbsp;&quot;1.0.0&quot;],<br>&nbsp;&nbsp;7:&nbsp;[38.8882,&nbsp;-77.01988],<br>&nbsp;&nbsp;8:&nbsp;&quot;2024-09-01T13:28:02-02:00&quot;,<br>&nbsp;&nbsp;-1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-50,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;6,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;6:&nbsp;h'2c10f412440ac53649bbcfe2acdf3f9ed2813f9a522392d4175db940562ad69cdd6444ac2de53e1333b0e2cb8ffc26e2f309188733352bbc98db6075d2b8e000'<br>&nbsp;&nbsp;}<br>}</div></div>
<h5 id='5.2.signature-validation'>5.2.&nbsp; Signature&nbsp;Validation</h5>
Now combine the objects retrieved during the decryption phase
by copying the first object (<a href='#3.3.pass-through-data'>&quot;Pass&nbsp;Through&quot;&nbsp;Data</a>)
to a label <code>1</code> of the second object.
Note that the length of the resulting <code>map</code> object
<b>must</b> be updated to reflect the addition of an item.
This operation effectively <i>recreates</i> the <a href='#3.6.signed-authorization'>Signed&nbsp;Authorization</a> object:
<div class='webpkifloat'><div class='webpkibox' id='signed-authz.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;722385402&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;EUR&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;mybank.com&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;2:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;3:&nbsp;&quot;FR7630002111110020050014382&quot;,<br>&nbsp;&nbsp;4:&nbsp;&quot;010049255&quot;,<br>&nbsp;&nbsp;5:&nbsp;[&quot;Android&quot;,&nbsp;&quot;14.1&quot;],<br>&nbsp;&nbsp;6:&nbsp;[&quot;Saturn&quot;,&nbsp;&quot;1.0.0&quot;],<br>&nbsp;&nbsp;7:&nbsp;[38.8882,&nbsp;-77.01988],<br>&nbsp;&nbsp;8:&nbsp;&quot;2024-09-01T13:28:02-02:00&quot;,<br>&nbsp;&nbsp;-1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-50,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;6,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;6:&nbsp;h'2c10f412440ac53649bbcfe2acdf3f9ed2813f9a522392d4175db940562ad69cdd6444ac2de53e1333b0e2cb8ffc26e2f309188733352bbc98db6075d2b8e000'<br>&nbsp;&nbsp;}<br>}</div></div>
Since this object contains a <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/signatures.html'>CSF<img src='xtl.svg' alt='csf'></a> <kbd>publicKey</kbd>
attribute, it can be validated using &quot;as&nbsp;is&quot;.
<p>
Note that the <i>authenticity</i> of received public keys <b>must</b>
be verified <i>before</i> authorization objects are acted upon!
</p>
<p>
Unsurprisingly, authorization objects <b>must</b> also
be checked for alignment with the specification.
Missing, additional, or malformed elements <b>must</b> be rejected.
</p>
<h3 id='6.test-vectors'>6.&nbsp; Test&nbsp;Vectors</h3>
Equipped with an appropriate diagnostic notation parser like
<a href='https://cyberphone.github.io/CBOR.js/doc/playground.html'>
https://cyberphone.github.io/CBOR.js/doc/playground.html
</a> and <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/encryption.html'>CEF<img src='xtl.svg' alt='cef'></a>/<a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/signatures.html'>CSF<img src='xtl.svg' alt='csf'></a> support, the <a href='#2.3.payer-authorization'>Payer&nbsp;Authorization</a> sample
should be possible to decrypt and validate, using the following sample keys.
<div style='margin-top:0.8em'>Authorization key in JWK format:</div>
<div class='webpkifloat'><div class='webpkibox' id='authorization-key.jwk' style='width:50em'>{<br>&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;OKP&quot;,<br>&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;Ed25519&quot;,<br>&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;_kms9bkrbpI1lPLoM2j2gKySS-k89TOuyvgC43dX-Mk&quot;,<br>&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;0flr-6bXs459f9qwAq20Zs3NizTGIEH5_rTDFoumFV4&quot;<br>}<br></div></div>
<div style='margin-top:0.8em'>Authorization key in COSE format:</div>
<div class='webpkifloat'><div class='webpkibox' id='authorization-key.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;-1:&nbsp;6,<br>&nbsp;&nbsp;-2:&nbsp;h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9',<br>&nbsp;&nbsp;-4:&nbsp;h'd1f96bfba6d7b38e7d7fdab002adb466cdcd8b34c62041f9feb4c3168ba6155e'<br>}</div></div>
<div style='margin-top:0.8em'>Encryption key in JWK format:</div>
<div class='webpkifloat'><div class='webpkibox' id='encryption-key.jwk' style='width:50em'>{<br>&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;EC&quot;,<br>&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;P-256&quot;,<br>&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;6BKxpty8cI-exDzCkh-goU6dXq3MbcY0cd1LaAxiNrU&quot;,<br>&nbsp;&nbsp;&quot;y&quot;:&nbsp;&quot;mCbcvUzm44j3Lt2b5BPyQloQ91tf2D2V-gzeUxWaUdg&quot;,<br>&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;6XxMFXhcYT5QN9w5TIg2aSKsbcj-pj4BnZkK7ZOt4B8&quot;<br>}<br></div></div>
<div style='margin-top:0.8em'>Encryption key in COSE format:</div>
<div class='webpkifloat'><div class='webpkibox' id='encryption-key.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;2,<br>&nbsp;&nbsp;-1:&nbsp;1,<br>&nbsp;&nbsp;-2:&nbsp;h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>&nbsp;&nbsp;-3:&nbsp;h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8',<br>&nbsp;&nbsp;-4:&nbsp;h'e97c4c15785c613e5037dc394c88366922ac6dc8fea63e019d990aed93ade01f'<br>}</div></div>
<h3 id='7.version'>7.&nbsp; Version</h3>
  API version: 0.5<br>
  Document version: 2024-09-07<br>
  Author: Anders Rundgren (<code>anders.rundgren.net@gmail.com</code>)
</body>
</html>