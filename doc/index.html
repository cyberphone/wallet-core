<!DOCTYPE html>
<html lang='en'>
<head>
  <link rel='icon' href='webpkiorg.png' sizes='192x192'>
  <meta name='viewport' content='initial-scale=1.0'>
  <meta charset='UTF-8'>
  <title>Wallet Core</title>
  <link rel='stylesheet' type='text/css' href='style.css'>
  <script>
    function tocSwitch(ip) {
      console.log(ip.parentNode.nextSibling);
      if (ip.src.indexOf('closed.svg') > 0) {
        ip.src = 'open.svg';
        ip.parentNode.nextSibling.style = 'display:block';
      } else {
        ip.src = 'closed.svg';
        ip.parentNode.nextSibling.style = 'display:none';
      }
    }
  </script>
</head>
<body>
<img src='saturnlogo.svg' alt='logo' style='width:10em;max-width:30%'>
<img style="width:10em;max-width:30%;position:absolute;right:1em;top:1em"
src="ipr.svg" alt="IPR declaration" title="IPR declaration">
<h3 style="text-align:center;font-weight:normal;font-size:1.5em">Saturn - Payment Authorization Wallet</h3>
<i>Disclaimer: this is a system in development, subject to change without notice.</i>
<p>
Copyright Notice: this document is furnished under an
<a href='https://github.com/cyberphone/wallet-core/blob/main/LICENSE'>MIT license</a>.
</p>
<h3>Table of Contents</h3>
<div class='webpkifloat'><div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#1.introduction'>1.&nbsp; Introduction</a></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='closed.svg' onclick='tocSwitch(this)' style='height:1em;margin-right:1em;cursor:pointer'><a href='#2.detailed-operation'>2.&nbsp; Detailed&nbsp;Operation</a></div><div style='display:none'>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.1.sequence-diagram'>2.1.&nbsp; Sequence&nbsp;Diagram</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.2.wallet-initiation'>2.2.&nbsp; Wallet&nbsp;Initiation</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.3.wallet-request-ui'>2.3.&nbsp; Wallet&nbsp;Request&nbsp;UI</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.4.payer-authorization'>2.4.&nbsp; Payer&nbsp;Authorization</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.5.payee-processing'>2.5.&nbsp; Payee&nbsp;Processing</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.6.calling-the-payment-network'>2.6.&nbsp; Calling&nbsp;the&nbsp;Payment&nbsp;Network</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#2.7.wallet-termination'>2.7.&nbsp; Wallet&nbsp;Termination</a></div></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='closed.svg' onclick='tocSwitch(this)' style='height:1em;margin-right:1em;cursor:pointer'><a href='#3.message-reference'>3.&nbsp; Message&nbsp;Reference</a></div><div style='display:none'>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.1.authorization-request'>3.1.&nbsp; Authorization&nbsp;Request</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.2.payment-request'>3.2.&nbsp; Payment&nbsp;Request</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.3.authorization-response'>3.3.&nbsp; Authorization&nbsp;Response</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.4.key-encryption'>3.4.&nbsp; Key&nbsp;Encryption</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.5.unencrypted-data'>3.5.&nbsp; Unencrypted&nbsp;Data</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.6.provider-info'>3.6.&nbsp; Provider&nbsp;Info</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.7.response-encryption'>3.7.&nbsp; Response&nbsp;Encryption</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#3.8.signed-authorization'>3.8.&nbsp; Signed&nbsp;Authorization</a></div></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#4.credential-database'>4.&nbsp; Credential&nbsp;Database</a></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#5.credential-enrollment'>5.&nbsp; Credential&nbsp;Enrollment</a></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='closed.svg' onclick='tocSwitch(this)' style='height:1em;margin-right:1em;cursor:pointer'><a href='#6.authorization-processing'>6.&nbsp; Authorization&nbsp;Processing</a></div><div style='display:none'>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#6.1.decryption'>6.1.&nbsp; Decryption</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#6.2.signature-validation'>6.2.&nbsp; Signature&nbsp;Validation</a></div></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='closed.svg' onclick='tocSwitch(this)' style='height:1em;margin-right:1em;cursor:pointer'><a href='#7.non-direct-payments-(ndp)'>7.&nbsp; Non-direct&nbsp;Payments&nbsp;(NDP)</a></div><div style='display:none'>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#7.1.ndp-objects'>7.1.&nbsp; NDP&nbsp;Objects</a></div>
<div style='padding: 0 0 0.4em 4em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#7.2.gas-station-payments'>7.2.&nbsp; Gas&nbsp;Station&nbsp;Payments</a></div></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#8.algorithm-support'>8.&nbsp; Algorithm&nbsp;Support</a></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#9.security-considerations'>9.&nbsp; Security&nbsp;Considerations</a></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#10.test-vectors'>10.&nbsp; Test&nbsp;Vectors</a></div>
<div style='padding: 0 0 0.4em 2em'><img alt='n/a' src='empty.svg' style='height:1em;margin-right:1em'><a href='#11.version'>11.&nbsp; Version</a></div>

</div></div>
<h3 id='1.introduction'>1.&nbsp; Introduction</h3>
This document describes the core components of the Saturn wallet.
Note that Saturn is a <i>payment authorization </i> system for end-users,
not a payment system.  Saturn is heavily influenced by the current
&quot;gold&nbsp;standard&quot; for consumer payments, <a href='https://www.emvco.com/' style='white-space:nowrap'>EMV<img src='xtl.svg' alt='emv'></a>.
<p style='padding-bottom:0;margin-bottom:0'>
Compared to EMV, Saturn introduces several enhancements:
</p>
<ul style='padding-top:0;margin-top:0'>
  <li style='padding-top:0.5em'>For privacy reasons user-specific authorization data is <i>encrypted</i>.</li>
  <li>Intended to work with <i>any</i> account-based payment system.</li>
  <li>Eliminates specific on-line solutions like 3D Secure.</li>
  <li>Receipt option.</li>
  <li>Account balance option.</li>
  <li>Built-in support for authorization of non-direct payments.</li>
</ul>
<p>
Saturn builds on the idea that different payment networks should not
need unique user authorizations solutions; only identifiers
related to accounts and payment networks need to be adapted.
This data is provided in the associated payment credentials
(virtual payment cards),
potentially making the wallet software <i>universal</i>.
</p>
Saturn is also intended to serve as a candidate for the
payment authorization part of the EU Digital Identity (EUDI) Wallet [<a href='https://ec.europa.eu/digital-building-blocks/sites/display/EUDIGITALIDENTITYWALLET/EU+Digital+Identity+Wallet+Home' style='white-space:nowrap'>EUDIW<img src='xtl.svg' alt='eudiw'></a>].
<h3 id='2.detailed-operation'>2.&nbsp; Detailed&nbsp;Operation</h3>
To guide the reader, this document is based on an example which
in turn provides links to the formal definitions.
<p>
The Saturn protocol is based on CBOR [<a href='https://www.rfc-editor.org/rfc/rfc8949.html' style='white-space:nowrap'>RFC8949<img src='xtl.svg' alt='rfc8949'></a>] which is a <i>binary</i> interchange format.
However, for documentation purposes, messages are shown in <i>diagnostic notation</i>.
</p>
To support cryptographic operations requiring secure transformations of CBOR <code>map</code> objects,
Saturn relies on an IETF standard currently in development [<a href='https://datatracker.ietf.org/doc/draft-ietf-cbor-cde/' style='white-space:nowrap'>CDE<img src='xtl.svg' alt='cde'></a>],
which defines <i>deterministic encoding</i> of CBOR.
<h5 id='2.1.sequence-diagram'>2.1.&nbsp; Sequence&nbsp;Diagram</h5>
The sequence diagram below outlines the Saturn protocol: 
<div class='webpkifloat'><img src='sequence-diagram.png' class='webpkibox' style='width:50em' title='Sequence Diagram'></div>
Payer icon provided through the courtesy of 
<a href='https://commons.wikimedia.org/wiki/File:Crystal_Clear_kdm_user_female.svg'>wikimedia.org<img src='xtl.svg' alt='payer'></a>.
<h5 id='2.2.wallet-initiation'>2.2.&nbsp; Wallet&nbsp;Initiation</h5>
The payment process is initiated when the <code class='entity'>Payer</code> hits a &quot;Pay&quot;
button on the Web or scans a QR-code, returning a <code class='entity'>Wallet</code> activation URL.
The <code class='entity'>Wallet</code> should then use the received URL for performing an HTTP&nbsp;GET
(step #1 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>) to the <code class='entity'>Payee</code> service.
This operation should return an <a href='#3.1.authorization-request'>Authorization&nbsp;Request</a> object
(step #2 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>) like the following:
<div class='webpkifloat'><div class='webpkibox' id='authz-req.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;EUR&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;20241216.00079&quot;<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;2:&nbsp;[&quot;https://cardnetwork.com&quot;,&nbsp;&quot;https://banknet2.org&quot;],<br>&nbsp;&nbsp;3:&nbsp;&quot;https://spaceshop.com/receipts/20241216.00079.MNloPyPahXxr43flXzufdQ&quot;<br>}</div></div>
Note that the <code class='entity'>Payee</code> service <b>must</b> set the
HTTP <code style='white-space:nowrap'>Content-Type</code> header parameter
to <code>application/cbor</code>.
<h5 id='2.3.wallet-request-ui'>2.3.&nbsp; Wallet&nbsp;Request&nbsp;UI</h5>
After receival of the <a href='#3.1.authorization-request'>Authorization&nbsp;Request</a>,
the <code class='entity'>Wallet</code> should display a UI like the following:
<div class='webpkifloat'><img src='wallet-ui.svg' style='padding:0;width:28em' class='webpkibox'  title='Wallet UI'></div>
If there are multiple <a href='#4.credential-database'>Credential&nbsp;Database</a> entries
matching the <a href='#3.1.authorization-request'>Authorization&nbsp;Request</a>,
the <code class='entity'>Payer</code> needs
to select (step #3 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>) a suitable
credential, unless the default (or last used) credential already meets
the preferences of the <code class='entity'>Payer</code>.
<p>
In the <i>non-normative</i> sample UI, credential selection is performed through swiping the card images.
</p><p>
If there are no matching payment credentials, the <code class='entity'>Wallet</code>
<b>must</b> provide the <code class='entity'>Payer</code> with
a suitable error message and a cancel button. 
</p>
<p>
If the requested currency differs from the default (as defined by the
locale settings of the operating system), it is <i>recommended</i> displaying
ISO three-letter abbreviations (USD, EUR, SEK, etc.) rather than short-hand
versions like <code>'$'</code> and <code>'&#x20ac;'</code>.
See also <a href='#3.2.payment-request'>Payment&nbsp;Request</a>.
</p>
<h5 id='2.4.payer-authorization'>2.4.&nbsp; Payer&nbsp;Authorization</h5>
Assuming that the <code class='entity'>Payer</code> accepts and subsequently authorizes 
the request (step #4 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>) using a biometric operation or PIN,
the <code class='entity'>Wallet</code> should perform an HTTP&nbsp;POST
(step #5 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>)
to the <code class='entity'>Payee</code> service containing an
<a href='#3.3.authorization-response'>Authorization&nbsp;Response</a>
object like the following: 
<div class='webpkifloat'><div class='webpkibox' id='authz-res.txt' style='width:50em'>1010([&quot;https://cyberphone.github.io/saturn/enc/v1&quot;,&nbsp;{<br>&nbsp;&nbsp;0:&nbsp;1010([&quot;https://cyberphone.github.io/saturn/sig/v1&quot;,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;EUR&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;20241216.00079&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;mybank.com&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;2024-12-10T13:28:02-01:00&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}]),<br>&nbsp;&nbsp;1:&nbsp;3,<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-29,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3:&nbsp;h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;7:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'8b716b71030a9bfea00bb0d7ff241b5fb96add50afac5e5f3e7a34aba7967c52',<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3:&nbsp;h'330837a80a6b24358364cd2eeefa4edc188a4f86d6e87c1d6ab7733d7ecae805'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;10:&nbsp;h'7d4923156875a9dc7f4dc3979224a80541c7d15ac2d99591921dff1418a1170a6754c58f6e81a61f'<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;8:&nbsp;h'ddd99faf2df8c9221f4a2009cc818ce5',<br>&nbsp;&nbsp;9:&nbsp;h'f2a587f034cdabc575151120',<br>&nbsp;&nbsp;10:&nbsp;h'2eb15c46f407fab6395b2193e28efabb8f6c7c32191b5206b03dd68709316b9810408c5e341403dde60520251137198aaa4b3bd7e1486ce05fdf1489a97e443ce51f3755a98895f856b1a658fc851008f9d24dcbf4534cb2b7cf09645dd6af00baa888f3d9263dbe2b3e9f34bf6ef84c3495152455642e41eed300ec041b681a6dfe6be9f4098979b3e6720a2eac7dac882b2ea7a5fbb12f2024e92310e327fe467a89f17c64f64ac72d8f8e7f4821dedc30d985d22da7803271ad0002caed7a9266d62ead82a4cbb02ce8dada008a0eae8336a636432531cb1fea6b71d869e64c88b61884e5af808242db5f60d34981a074'<br>}])</div></div>
Note that the POST <b>must</b> be directed to the same URL as
used by the GET in <a href='#2.2.wallet-initiation'>Wallet&nbsp;Initiation</a>.
In addition, the HTTP <code style='white-space:nowrap'>Content-Type</code>
header parameter <b>must</b> be set to <code>application/cbor</code>.
<h5 id='2.5.payee-processing'>2.5.&nbsp; Payee&nbsp;Processing</h5>
After receiving the <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a>, the <code class='entity'>Payee</code>
<b>must</b> perform a number of checks
on the <a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a> object including:
<ul style='padding-top:0;margin-top:0.5em'>
  <li style='padding-top:0'>Verify that the
    <kbd>paymentRequest</kbd> object is identical to the original request.</li>
  <li>Verify that the <kbd>providerInfo</kbd> object contains a supported
    <kbd>networkId</kbd>.</li>
  <li>Verify that <kbd>timeStamp</kbd> deviates less than &pm;30 seconds from
    the current time.</li>
  <li>Verify that <kbd>payeeHost</kbd> matches that of the
    <code class='entity'>Payee</code>.</li>
</ul>
If any validation step fails, the authorization process <b>must</b> be aborted
including providing the <code class='entity'>Payer</code> with
a suitable error message,
<h5 id='2.6.calling-the-payment-network'>2.6.&nbsp; Calling&nbsp;the&nbsp;Payment&nbsp;Network</h5>
After successful validation of the <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a>,
the <code class='entity'>Payee</code>
includes this object in a <i>payment-network-specific</i> request to the designated
<code class='entity'>Payment</code>&#8201;<code class='entity'>Network</code>
(provided by the selected payment credential).
Note that this phase may constitute of <i>multiple</i> request-response pairs.
<h5 id='2.7.wallet-termination'>2.7.&nbsp; Wallet&nbsp;Termination</h5>
After successful (or failed) authorization, the <code class='entity'>Payee</code>
<b>must</b> return a <code class='entity'>Wallet</code> termination
message (step #6 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>).
This message depends on how the payment process was initiated,
and is currently TBD.
<h3 id='3.message-reference'>3.&nbsp; Message&nbsp;Reference</h3>
This section contains a reference to the components underpinning Saturn messages.
The components are based on CBOR <code>map</code> objects.
<h5 id='3.1.authorization-request'>3.1.&nbsp; Authorization&nbsp;Request</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>paymentRequest</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>map</code></td><td><a href='#3.2.payment-request'>Payment&nbsp;Request</a> is the core <code class='entity'>Payee</code> request object.</td></tr><tr><td><kbd>supportedNetworks</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>array</code></td><td>Non-empty list of payment network/method identifiers that the <code class='entity'>Payee</code> supports. Network identifiers are expressed as CBOR strings (tstr).<div style='padding-top:0.5em'>See also <kbd>networkId</kbd> in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</div></td></tr><tr><td><kbd>receiptUrl</kbd></td><td style='text-align:center'><code>3</code></td><td style='text-align:center'><code>tstr</code></td><td><i>Optional</i>: URL to a <code class='entity'>Payee</code> receipt service.<div style='padding-top:0.5em'>See also <a href='https://cyberphone.github.io/doc/defensive-publications/e-receipts.pdf' style='white-space:nowrap'>RECEIPTS<img src='xtl.svg' alt='receipts'></a>.</div></td></tr></table></div>The Authorization Request represents the primary <code class='entity'>Payee</code> to <code class='entity'>Wallet</code> message. In same-device Web contexts this message is also associated with the invocation of the <code class='entity'>Wallet</code>.
<h5 id='3.2.payment-request'>3.2.&nbsp; Payment&nbsp;Request</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>commonName</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>tstr</code></td><td><code class='entity'>Payee</code> common name to be shown in the <a href='#2.3.wallet-request-ui'>Wallet&nbsp;Request&nbsp;UI</a><div style='padding-top:0.5em'>Note that common and <i>legal</i> names often differ.</div></td></tr><tr><td><kbd>amount</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>tstr</code></td><td>Monetary amount compatible with the regular expression: <code style='white-space:nowrap'>^(0|[1-9][0-9]*)(\.[0-9]+)?$</code>. <div style='padding-top:0.5em'>Amounts <b>must&nbsp;not</b> use more decimals than is custom for prices for the specific <kbd>currency</kbd>.</div></td></tr><tr><td><kbd>currency</kbd></td><td style='text-align:center'><code>3</code></td><td style='text-align:center'><code>tstr</code></td><td>Currency expressed in the <a href='https://www.iso.org/iso-4217-currency-codes.html' style='white-space:nowrap'>ISO4217<img src='xtl.svg' alt='iso4217'></a> <i>alphabetical</i> format.</td></tr><tr><td><kbd>referenceId</kbd></td><td style='text-align:center'><code>4</code></td><td style='text-align:center'><code>tstr</code></td><td><code class='entity'>Payee</code> reference Id. <div style='padding-top:0.5em'>Reference Ids <b>must</b> be unique with respect to the <code class='entity'>Payee</code>.</div></td></tr><tr><td><kbd>nonDirectPayment</kbd></td><td style='text-align:center'><code>5</code></td><td style='text-align:center'><code>cotx</code></td><td><i>Optional</i>: See also <a href='#7.non-direct-payments-(ndp)'>Non-direct&nbsp;Payments&nbsp;(NDP)</a>.</td></tr></table></div>
<h5 id='3.3.authorization-response'>3.3.&nbsp; Authorization&nbsp;Response</h5>An Authorization Response consists of a single <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/encryption.html' style='white-space:nowrap'>CEF<img src='xtl.svg' alt='cef'></a> object, where the outermost element is a <a href='https://www.ietf.org/archive/id/draft-rundgren-cotx-04.html' style='white-space:nowrap'>COTX<img src='xtl.svg' alt='cotx'></a> wrapper as follows:<div class='webpkifloat'><div style='padding:1em 2em'><code>1010([&quot;https://cyberphone.github.io/saturn/enc/v1&quot;,&nbsp;{<br></code><div style='padding:1em 0 1em 2em'><i>CEF container...</i></div><code>}])</code></div></div>Note that the COTX wrapper is included in the encryption process by constituting a part of the Additional Authentication Data (AAD).<div style='padding-top:0.5em'>The CEF container <code>map</code> keys are as follows:</div><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>customData</kbd></td><td style='text-align:center'><code>0</code></td><td style='text-align:center'><code>map</code></td><td>CEF custom (<i>unencrypted</i>) data in the form of a copy of the <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> object where all <code>map</code> objects except for the <a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a> object have been removed.<div style='padding-top:0.5em'>Also see <a href='#6.1.decryption'>Decryption</a>.</div></td></tr><tr><td><kbd>algorithm</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>int</code></td><td>Copy of the <kbd>encContentAlg</kbd> attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>keyEncryption</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>map</code></td><td>Holds the CEF <a href='#3.4.key-encryption'>Key&nbsp;Encryption</a> object.</td></tr><tr><td><kbd>tag</kbd></td><td style='text-align:center'><code>8</code></td><td style='text-align:center'><code>bstr</code></td><td>Encryption algorithm tag.</td></tr><tr><td><kbd>iv</kbd></td><td style='text-align:center'><code>9</code></td><td style='text-align:center'><code>bstr</code></td><td>Encryption algorithm initialization vector (IV).</td></tr><tr><td><kbd>cipherText</kbd></td><td style='text-align:center'><code>10</code></td><td style='text-align:center'><code>bstr</code></td><td>Encrypted version of the outermost <code>map</code> object of the <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> object where the <a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a> object has been removed.<div style='padding-top:0.5em'>Also see <a href='#6.1.decryption'>Decryption</a>.</div></td></tr></table></div>See also <a href='#6.authorization-processing'>Authorization&nbsp;Processing</a>.<p>Note that <code>&quot;https://cyberphone.github.io/saturn/enc/v1&quot;</code> represents a temporary name allocation.</p>
<h5 id='3.4.key-encryption'>3.4.&nbsp; Key&nbsp;Encryption</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>algorithm</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>int</code></td><td>Copy of the <kbd>encKeyAlg</kbd> attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>keyId</kbd></td><td style='text-align:center'><code>3</code></td><td style='text-align:center'><code>&quot;</code><i>Any</i><code>&quot;</code></td><td><i>Optional</i>: Copy of the <kbd>encKeyId</kbd> attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>publicKey</kbd></td><td style='text-align:center'><code>4</code></td><td style='text-align:center'><code>map</code></td><td><i>Optional</i>: Copy of the <kbd>encPublicKey</kbd> object of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.<div style='padding-top:0.5em'>Note that <kbd>keyId</kbd> and <kbd>publicKey</kbd> are <i>mutually exclusive</i>.</div></td></tr><tr><td><kbd>ephemeralKey</kbd></td><td style='text-align:center'><code>7</code></td><td style='text-align:center'><code>map</code></td><td>Ephemeral ECDH public key.</td></tr><tr><td><kbd>cipherText</kbd></td><td style='text-align:center'><code>10</code></td><td style='text-align:center'><code>bstr</code></td><td><i>Optional</i>: Encrypted key for <i>key&nbsp;wrapping</i> algorithms.</td></tr></table></div>
<h5 id='3.5.unencrypted-data'>3.5.&nbsp; Unencrypted&nbsp;Data</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>paymentRequest</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>map</code></td><td>Through the inclusion of a copy of the <a href='#3.2.payment-request'>Payment&nbsp;Request</a> in the <code class='entity'>Payer</code> authorization, this object remains <i>authoritative</i> throughout the payment process (except for interbank operations).</td></tr><tr><td><kbd>providerInfo</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>map</code></td><td>Holds the <a href='#3.6.provider-info'>Provider&nbsp;Info</a> required by the <code class='entity'>Payee</code> for deriving which payment network to use and how to initiate a compatible payment transaction request.</td></tr><tr><td><kbd>payeeHost</kbd></td><td style='text-align:center'><code>3</code></td><td style='text-align:center'><code>tstr</code></td><td>Host name or IP address of the invoking <code class='entity'>Payee</code>, derived from the URL obtained in step #1 in the sequence diagram.<div style='padding-top:0.5em'>The purpose of the <kbd>payeeHost</kbd> attribute is to provide a means for a <code class='entity'>Payment Network</code> to verify that the origin of a received <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a> matches that of the <code class='entity'>Payee</code>. This is essentially an inverted version of the phishing protection method used by WebAuthn [<a href='https://www.w3.org/TR/webauthn/' style='white-space:nowrap'>WEBAUTHN<img src='xtl.svg' alt='webauthn'></a>].</div><div style='padding-top:0.5em'>The security of this arrangement also depends on that forwarded <code class='entity'>Payee</code> requests are properly authenticated.</div></td></tr><tr><td><kbd>timeStamp</kbd></td><td style='text-align:center'><code>4</code></td><td style='text-align:center'><code>tstr</code></td><td>ISO date-time string [<a href='https://www.rfc-editor.org/rfc/rfc3339' style='white-space:nowrap'>RFC3339<img src='xtl.svg' alt='rfc3339'></a>] using UTC (T) or local time (Z) format.<div style='padding-top:0.5em'>The purpose of the <kbd>timeStamp</kbd> attribute is to provide a means for an <code class='entity'>Issuer</code> to verify the &quot;freshness&quot; of a received <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a>. The recommended method is using a cache holding a hash of the associated <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> and its <kbd>timeStamp</kbd>, where the latter is used to automatically remove a cache entry when the authorization is considered to be expired. This arrangement is either used for protection against replay, or for supporting <i>idempotent</i> operation.</div><div style='padding-top:0.5em'>Note that authorizations that already have expired or are too new <b>must</b> be rejected.</div><div style='padding-top:0.5em'><i>Tentative</i> lower limit: <kbd>timeStamp</kbd><code> &gt; currentTime - 600s</code><br><i>Tentative</i> higher limit: <kbd>timeStamp</kbd><code> &lt; currentTime + 60s</code></div></td></tr></table></div>
<h5 id='3.6.provider-info'>3.6.&nbsp; Provider&nbsp;Info</h5><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>networkId</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>serviceLocator</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr></table></div>
<h5 id='3.7.response-encryption'>3.7.&nbsp; Response&nbsp;Encryption</h5>The Response Encryption object provides a means for an <code class='entity'>Issuer</code> to return messages to the <code class='entity'>Payer</code> like &quot;Out&nbsp;of&nbsp;funds&quot; through the regular transaction channel, and that without revealing any personal information to intermediaries. In addition, Response Encryption also serves as a strong <i>nonce</i>, ensuring that <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> objects become unique, irrespective of <a href='#3.1.authorization-request'>Authorization&nbsp;Request</a> data and time-stamps.<div style='padding-top:0.5em'>This concept can also be used to force the <code class='entity'>Payer</code> to provide additional information which could be needed for high-value or &quot;suspicious&quot; transaction requests.</div><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>algorithm</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>int</code></td><td>Copy of the <kbd>encKeyAlg</kbd> attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>instanceKey</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>bstr</code></td><td>Random encryption key, initialized for each authorization request.<div style='padding-top:0.5em'>The length of the <kbd>instanceKey</kbd> attribute <b>must</b> match the <kbd>algorithm</kbd>.</div></td></tr></table></div>
<h5 id='3.8.signed-authorization'>3.8.&nbsp; Signed&nbsp;Authorization</h5>A Signed Authorization consists of a CBOR map wrapped in a <a href='https://www.ietf.org/archive/id/draft-rundgren-cotx-04.html' style='white-space:nowrap'>COTX<img src='xtl.svg' alt='cotx'></a> container as follows:<div class='webpkifloat'><div style='padding:1em 2em'><code>1010([&quot;https://cyberphone.github.io/saturn/sig/v1&quot;,&nbsp;{<br></code><div style='padding:1em 0 1em 2em'><i>CBOR map...</i></div><code>}])</code></div></div>Note that the COTX wrapper is included in the signature process as well.<div style='padding-top:0.5em'>The CBOR <code>map</code> keys are as follows:</div><div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Label</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>unencryptedData</kbd></td><td style='text-align:center'><code>1</code></td><td style='text-align:center'><code>map</code></td><td>Holds the <a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a> object.</td></tr><tr><td><kbd>responseEncryption</kbd></td><td style='text-align:center'><code>2</code></td><td style='text-align:center'><code>map</code></td><td>Holds the <a href='#3.7.response-encryption'>Response&nbsp;Encryption</a> object.</td></tr><tr><td><kbd>accountId</kbd></td><td style='text-align:center'><code>3</code></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>serialNumber</kbd></td><td style='text-align:center'><code>4</code></td><td style='text-align:center'><code>tstr</code></td><td>Copy of the same attribute of the selected payment credential in the <a href='#4.credential-database'>Credential&nbsp;Database</a>.</td></tr><tr><td><kbd>platformData</kbd></td><td style='text-align:center'><code>5</code></td><td style='text-align:center'><code>array</code></td><td>Array holding the name and version of the operating system in <code>[0]</code> and <code>[1]</code> respectively, expressed as CBOR strings (tstr).</td></tr><tr><td><kbd>walletData</kbd></td><td style='text-align:center'><code>6</code></td><td style='text-align:center'><code>array</code></td><td>Array holding the name and version of the <code class='entity'>Wallet</code> software in <code>[0]</code> and <code>[1]</code> respectively, expressed as CBOR strings (tstr).</td></tr><tr><td><kbd>location</kbd></td><td style='text-align:center'><code>7</code></td><td style='text-align:center'><code>array</code></td><td><i>Optional</i>: Array holding the current latitude <code>[0]</code> and longitude <code>[1]</code> of the <code class='entity'>Wallet</code> device, expressed as CBOR floating point values.<div style='padding-top:0.5em'>This option depends on <code class='entity'>Payer</code> privacy settings.</div></td></tr><tr><td><kbd>authzSignature</kbd></td><td style='text-align:center'><code>-1</code></td><td style='text-align:center'><code>map</code></td><td>Authorization signature using a <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/signatures.html' style='white-space:nowrap'>CSF<img src='xtl.svg' alt='csf'></a> object.</td></tr></table></div>For an example, see <a href='#6.2.signature-validation'>Signature&nbsp;Validation</a>.<p>Note that <code>&quot;https://cyberphone.github.io/saturn/sig/v1&quot;</code> represents a temporary name allocation.</p>
<h3 id='4.credential-database'>4.&nbsp; Credential&nbsp;Database</h3>
A fundamental part of the <code class='entity'>Wallet</code> is a local database holding
enrolled payment credentials.
Note that although credential data types listed here are mainly expressed as CBOR,
other representations may be used.
The only requirement is that credential data types can be securely
mapped back and forth to CBOR.
<p>
The data type <code>&quot;ps&quot;</code> denotes a platform-specific solution.
</p>
<p style='margin-bottom:0.5em;padding-bottom:0'>
Each entry in the database contains a payment credential according
to the following definition:
</p>
<div class='webpkifloat'><table class='webpkitable' style='width:52em'><tr><th>Name</th><th>Type</th><th style='width:100%'>Description</th></tr><tr><td><kbd>version</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Since credential data may evolve over time, versioning is necessary. This specification covers version: <code style='white-space:nowrap'>https://cyberphone.github.io/saturn/cred/v1</code>.</td></tr><tr><td><kbd>networkId</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Payment network/method identifier. Since payment networks are likely to continue having unique message solutions, the <code class='entity'>Payee</code> needs to identify the specific network before making a transaction request.<div style='padding-top:0.5em'>Payment network identifiers may be expressed as URLs or as simple names like "VISA".  Note that this concept does not make a distinction between payment methods or "schemes".</div><div style='padding-top:0.5em'>See also <a href='#3.6.provider-info'>Provider&nbsp;Info</a>.</div></td></tr><tr><td><kbd>serviceLocator</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Payment service URL or host name. This attribute enables the <code class='entity'>Payee</code> to find the end-point of the specific payment service (like a bank), associated with the payment credential.<div style='padding-top:0.5em'>How to interpret this attribute is dictated by the <kbd>networkId</kbd> identifier. If <kbd>serviceLocator</kbd> is expressed as a host-name only, a <code style='white-space:nowrap'>&quot;/.well-known/&quot;</code> [<a href='https://www.rfc-editor.org/rfc/rfc8615' style='white-space:nowrap'>RFC8615<img src='xtl.svg' alt='rfc8615'></a>] URL extension would typically be used.</div><div style='padding-top:0.5em'>See also <a href='#3.6.provider-info'>Provider&nbsp;Info</a>.</div></td></tr><tr><td><kbd>accountId</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Account identifier associated with the payment credential.<div style='padding-top:0.5em'>See also <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a>.</div></td></tr><tr><td><kbd>serialNumber</kbd></td><td style='text-align:center'><code>tstr</code></td><td>Serial number of the payment credential.<div style='padding-top:0.5em'>See also <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a>.</div></td></tr><tr><td><kbd>cardImage</kbd></td><td style='text-align:center'><code>bstr</code></td><td>Card image associated with the payment credential. Card images are used for aiding <code class='entity'>Payer</code> administration of payment credentials as well as being featured in the <a href='#2.3.wallet-request-ui'>Wallet&nbsp;Request&nbsp;UI</a>. <div style='padding-top:0.5em'>Card images <b>must</b> be in <a href='https://www.w3.org/TR/SVG11/' style='white-space:nowrap'>SVG<img src='xtl.svg' alt='svg'></a> format and tentatively having a size of <code>300&times;180</code> pixels.</div></td></tr><tr><td><kbd>authzAlg</kbd></td><td style='text-align:center'><code>int</code></td><td>COSE signature algorithm to use for creating <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> objects.</td></tr><tr><td><kbd>authzKeyHandle</kbd></td><td style='text-align:center'><code>&quot;ps&quot;</code></td><td>Local handle to the private key to use for creating <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> objects.</td></tr><tr><td><kbd>authzPublicKey</kbd></td><td style='text-align:center'><code>&quot;ps&quot;</code></td><td>Authorization public key for inclusion in <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> objects.</td></tr><tr><td><kbd>encContentAlg</kbd></td><td style='text-align:center'><code>int</code></td><td>COSE content encryption algorithm to use for creating <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a> objects.</td></tr><tr><td><kbd>encKeyAlg</kbd></td><td style='text-align:center'><code>int</code></td><td>COSE key encryption algorithm to use for creating <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a> objects.</td></tr><tr><td><kbd>encPublicKey</kbd></td><td style='text-align:center'><code>&quot;ps&quot;</code></td><td>Encryption public key to use for creating <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a> objects.<div style='padding-top:0.5em'>Note that <kbd>encPublicKey</kbd> objects are provided by credential issuers. In order to serve their primary purpose, preserving privacy, <kbd>encPublicKey</kbd> objects <b>must</b> be <i>shared</i> by multiple clients.</div></td></tr><tr><td><kbd>encKeyId</kbd></td><td style='text-align:center'><code>&quot;</code><i>Any</i><code>&quot;</code></td><td><i>Optional</i>: If the <kbd>encKeyId</kbd> attribute is defined, it <b>must</b> be featured in <a href='#3.4.key-encryption'>Key&nbsp;Encryption</a> objects instead of <kbd>encPublicKey</kbd>.</td></tr></table></div>
<h3 id='5.credential-enrollment'>5.&nbsp; Credential&nbsp;Enrollment</h3>
TBD.
<h3 id='6.authorization-processing'>6.&nbsp; Authorization&nbsp;Processing</h3>
This section describes how
<a href='#3.3.authorization-response'>Authorization&nbsp;Response</a> messages
should be processed, using the <a href='#2.4.payer-authorization'>Payer&nbsp;Authorization</a> sample and
associated <a href='#10.test-vectors'>Test&nbsp;Vectors</a> as model data.
<h5 id='6.1.decryption'>6.1.&nbsp; Decryption</h5>
Firstly, the <a href='#3.3.authorization-response'>Authorization&nbsp;Response</a>
object needs to be <i>decrypted</i> using a private key associated with the 
supplied <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/encryption.html' style='white-space:nowrap'>CEF<img src='xtl.svg' alt='cef'></a> <kbd>publicKey</kbd> or <kbd>keyId</kbd> attribute.
In the sample, a <kbd>publicKey</kbd> attribute was used.
<p>
Note that enclosing <a href='https://www.ietf.org/archive/id/draft-rundgren-cotx-04.html' style='white-space:nowrap'>COTX<img src='xtl.svg' alt='cotx'></a> object <b>must</b> be included in
the decryption process.
</p>
<p>
The decryption process should return two CBOR objects.
</p>
1. The <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> object where all <code>map</code> objects
except for the <a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a> object have been removed.
Note that this item is already supplied in clear:
<div class='webpkifloat'><div class='webpkibox' id='unencrypted-data.txt' style='width:50em'>1010([&quot;https://cyberphone.github.io/saturn/sig/v1&quot;,&nbsp;{<br>&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;EUR&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;20241216.00079&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;mybank.com&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;2024-12-10T13:28:02-01:00&quot;<br>&nbsp;&nbsp;}<br>}])</div></div>
2. The remaining part of the <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> object
which after decryption should read like the following:
<div class='webpkifloat'><div class='webpkibox' id='restored.txt' style='width:50em'>{<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;3,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;h'7fdd851a3b9d2dafc5f0d00030e22b9343900cd42ede4948568a4a2ee655291a'<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;3:&nbsp;&quot;FR7630002111110020050014382&quot;,<br>&nbsp;&nbsp;4:&nbsp;&quot;010049255&quot;,<br>&nbsp;&nbsp;5:&nbsp;[&quot;Android&quot;,&nbsp;&quot;15&quot;],<br>&nbsp;&nbsp;6:&nbsp;[&quot;Saturn&quot;,&nbsp;&quot;1.0.0&quot;],<br>&nbsp;&nbsp;7:&nbsp;[38.8882,&nbsp;-77.01988],<br>&nbsp;&nbsp;-1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-50,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;6,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;6:&nbsp;h'da420819cef006c2dcc02df4f9e55cef5f18f3fd1bed0639ff8a42ed0ec68d8bd3c4017e082ea703ee76a37c46cecf2bc2d9bbbfaa136876e0d9116d2777eb08'<br>&nbsp;&nbsp;}<br>}</div></div>
<h5 id='6.2.signature-validation'>6.2.&nbsp; Signature&nbsp;Validation</h5>
Now combine the objects retrieved during the decryption phase
by <i>merging</i> the second <code>map</code> with the first <code>map</code> (<a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a>).
Note that the length of the resulting <code>map</code> object
<b>must</b> be updated to reflect the addition of an item.
This operation effectively <i>recreates</i> the <a href='#3.8.signed-authorization'>Signed&nbsp;Authorization</a> object:
<div class='webpkifloat'><div class='webpkibox' id='signed-authz.txt' style='width:50em'>1010([&quot;https://cyberphone.github.io/saturn/sig/v1&quot;,&nbsp;{<br>&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;Space&nbsp;Shop&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;600.00&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;EUR&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;20241216.00079&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;&quot;https://banknet2.org&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;&quot;mybank.com&quot;<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;&quot;spaceshop.com&quot;,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;&quot;2024-12-10T13:28:02-01:00&quot;<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;2:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;3,<br>&nbsp;&nbsp;&nbsp;&nbsp;2:&nbsp;h'7fdd851a3b9d2dafc5f0d00030e22b9343900cd42ede4948568a4a2ee655291a'<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;3:&nbsp;&quot;FR7630002111110020050014382&quot;,<br>&nbsp;&nbsp;4:&nbsp;&quot;010049255&quot;,<br>&nbsp;&nbsp;5:&nbsp;[&quot;Android&quot;,&nbsp;&quot;15&quot;],<br>&nbsp;&nbsp;6:&nbsp;[&quot;Saturn&quot;,&nbsp;&quot;1.0.0&quot;],<br>&nbsp;&nbsp;7:&nbsp;[38.8882,&nbsp;-77.01988],<br>&nbsp;&nbsp;-1:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;-50,<br>&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1:&nbsp;6,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-2:&nbsp;h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9'<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;6:&nbsp;h'da420819cef006c2dcc02df4f9e55cef5f18f3fd1bed0639ff8a42ed0ec68d8bd3c4017e082ea703ee76a37c46cecf2bc2d9bbbfaa136876e0d9116d2777eb08'<br>&nbsp;&nbsp;}<br>}])</div></div>
Since this object contains a <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/signatures.html' style='white-space:nowrap'>CSF<img src='xtl.svg' alt='csf'></a> <kbd>publicKey</kbd>
attribute, it can be validated using &quot;as&nbsp;is&quot;.
<p>
Note that the <i>authenticity</i> of received public keys <b>must</b>
be verified <i>before</i> authorization objects are acted upon!
</p>
<p>
Authorization objects <b>must</b> also
be checked for alignment with the specification.
Missing, additional, or malformed elements <b>must</b> be rejected.
</p>
<p>
See also <kbd>timeStamp</kbd> in <a href='#3.5.unencrypted-data'>Unencrypted&nbsp;Data</a>.
</p>
<h3 id='7.non-direct-payments-(ndp)'>7.&nbsp; Non-direct&nbsp;Payments&nbsp;(NDP)</h3>
Non-direct payments represent a group of payment-related
scenarios where an initial <code class='entity'>Payer</code>
authorization is followed by one 
or more operations performed by the <code class='entity'>Payee</code>,
usually without further intervention by the <code class='entity'>Payer</code>.
Here we find gas-station payments, 
subscriptions, BNPL (Buy Now Pay Later), and deposits.
<p>
Non-direct payments typically involve 
reservation of funds.  Subscriptions and BNPL may also be subject
to <code class='entity'>Payer</code> <i>credit considerations</i>.
</p>
<p>
Although this specification only defines a single non-direct payment scenario, 
this is intended to serve as a model for additional variants as well.
</p>
<h5 id='7.1.ndp-objects'>7.1.&nbsp; NDP&nbsp;Objects</h5>
NDP objects are denoted by a <a href='https://www.ietf.org/archive/id/draft-rundgren-cotx-04.html' style='white-space:nowrap'>COTX<img src='xtl.svg' alt='cotx'></a> object as follows:
<div class='webpkifloat'><div style='padding:1em 2em'>
  <code>1010([</code><kbd>ndpObjectId</kbd><code>,</code><br>
  <div style='padding:1em 0 1em 2em'><i>Additional Parameters</i></div>
  <code>])</code></div></div>
Note that <kbd>ndpObjectId</kbd> URLs <b>must</b> be unique 
and expressed as CBOR strings (<code>tstr</code>).
<h5 id='7.2.gas-station-payments'>7.2.&nbsp; Gas&nbsp;Station&nbsp;Payments</h5>
A gas station payment consists of two operations: 1) Reservation of a <i>maximum amount</i> of money to be used. 2) Resolving the reservation by debiting the <code class='entity'>Payer</code> for the actual cost of the fill-up. Note that a valid receipt (step #7 in the <a href='#2.1.sequence-diagram'>Sequence&nbsp;Diagram</a>) can only be made available after the second phase has been executed. <p>For gas station payments, <kbd>ndpObjectId</kbd> <b>must</b> be set to: <code>&quot;https://cyberphone.github.io/saturn/ndp/gas&quot;</code>, while the <i>Additional&nbsp;Parameters</i> consist of single CBOR integer (<code>int</code>) holding the number of hours (1-24) the reservation will remain valid before being automatically revoked by the account-holding entity. It is recommended to have a margin of at least 15 minutes.</p>The CBOR object <div class='webpkifloat'><div style='padding:1em 2em'><code>1010([&quot;https://cyberphone.github.io/saturn/ndp/gas&quot;, 2])</code></div></div>thus represents an argument to a <a href='#3.2.payment-request'>Payment&nbsp;Request</a>, for a gas station payment with a validity of 2 hours.<p>Note that <code>&quot;https://cyberphone.github.io/saturn/ndp/gas&quot;</code> represents a temporary name allocation.</p><p>Since non-direct payments differ from one-off payments, the <code class='entity'>Wallet</code> UI should also reflect such requests in a <i>meaningful</i> way.<p style='padding-bottom:0; margin-bottom:0'>For gas station payments, the following appears like a suitable solution:</p> <div class='webpkifloat'><img src='gas-payment-ui.svg' style='padding:0;width:28em' class='webpkibox' title='Partial Wallet UI'></div>
<h3 id='8.algorithm-support'>8.&nbsp; Algorithm&nbsp;Support</h3>
The following table shows the <i>minimum</i> algorithm support required:
<div class='webpkifloat'>
<table class='webpkitable'>
<tr><th>Name</th><th>Description</th></tr>
<tr><td style='text-align:center'><code>Ed25519</code></td>
<td rowspan='2'>Authorization (signature) algorithm.</td></tr>
<tr><td style='text-align:center'><code>ESP256</code></td></tr>
<tr><td style='text-align:center'><code>ECDH-ES+A128KW</code></td>
<td rowspan='2'>Key encryption algorithm for usage with <code>P-256</code> and <code>X25519</code> keys.</td></tr>
<tr><td style='text-align:center'><code>ECDH-ES+A256KW</code></td></tr>
<tr><td style='text-align:center'><code>A128GCM</code></td>
<td rowspan='2'>Content encryption algorithm.</td></tr>
<tr><td style='text-align:center'><code>A256GCM</code></td></tr>
</table>
</div>
<h3 id='9.security-considerations'>9.&nbsp; Security&nbsp;Considerations</h3>
TBD.
<h3 id='10.test-vectors'>10.&nbsp; Test&nbsp;Vectors</h3>
Equipped with an appropriate diagnostic notation parser like
<a href='https://cyberphone.github.io/CBOR.js/doc/playground.html'>
https://cyberphone.github.io/CBOR.js/doc/playground.html
</a> and <a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/encryption.html' style='white-space:nowrap'>CEF<img src='xtl.svg' alt='cef'></a>/<a href='https://cyberphone.github.io/javaapi/org/webpki/cbor/doc-files/signatures.html' style='white-space:nowrap'>CSF<img src='xtl.svg' alt='csf'></a> support, the <a href='#2.4.payer-authorization'>Payer&nbsp;Authorization</a> sample
should be possible to decrypt and validate, using the following sample keys.
<div style='margin-top:0.8em'>Authorization key in JWK format:</div>
<div class='webpkifloat'><div class='webpkibox' id='authorization-key.jwk' style='width:50em'>{<br>&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;OKP&quot;,<br>&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;Ed25519&quot;,<br>&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;_kms9bkrbpI1lPLoM2j2gKySS-k89TOuyvgC43dX-Mk&quot;,<br>&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;0flr-6bXs459f9qwAq20Zs3NizTGIEH5_rTDFoumFV4&quot;<br>}<br></div></div>
<div style='margin-top:0.8em'>Authorization key in COSE format:</div>
<div class='webpkifloat'><div class='webpkibox' id='authorization-key.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;1,<br>&nbsp;&nbsp;-1:&nbsp;6,<br>&nbsp;&nbsp;-2:&nbsp;h'fe49acf5b92b6e923594f2e83368f680ac924be93cf533aecaf802e37757f8c9',<br>&nbsp;&nbsp;-4:&nbsp;h'd1f96bfba6d7b38e7d7fdab002adb466cdcd8b34c62041f9feb4c3168ba6155e'<br>}</div></div>
<div style='margin-top:0.8em'>Encryption key in JWK format:</div>
<div class='webpkifloat'><div class='webpkibox' id='encryption-key.jwk' style='width:50em'>{<br>&nbsp;&nbsp;&quot;kty&quot;:&nbsp;&quot;EC&quot;,<br>&nbsp;&nbsp;&quot;crv&quot;:&nbsp;&quot;P-256&quot;,<br>&nbsp;&nbsp;&quot;x&quot;:&nbsp;&quot;6BKxpty8cI-exDzCkh-goU6dXq3MbcY0cd1LaAxiNrU&quot;,<br>&nbsp;&nbsp;&quot;y&quot;:&nbsp;&quot;mCbcvUzm44j3Lt2b5BPyQloQ91tf2D2V-gzeUxWaUdg&quot;,<br>&nbsp;&nbsp;&quot;d&quot;:&nbsp;&quot;6XxMFXhcYT5QN9w5TIg2aSKsbcj-pj4BnZkK7ZOt4B8&quot;<br>}<br></div></div>
<div style='margin-top:0.8em'>Encryption key in COSE format:</div>
<div class='webpkifloat'><div class='webpkibox' id='encryption-key.txt' style='width:50em'>{<br>&nbsp;&nbsp;1:&nbsp;2,<br>&nbsp;&nbsp;-1:&nbsp;1,<br>&nbsp;&nbsp;-2:&nbsp;h'e812b1a6dcbc708f9ec43cc2921fa0a14e9d5eadcc6dc63471dd4b680c6236b5',<br>&nbsp;&nbsp;-3:&nbsp;h'9826dcbd4ce6e388f72edd9be413f2425a10f75b5fd83d95fa0cde53159a51d8',<br>&nbsp;&nbsp;-4:&nbsp;h'e97c4c15785c613e5037dc394c88366922ac6dc8fea63e019d990aed93ade01f'<br>}</div></div>
<h3 id='11.version'>11.&nbsp; Version</h3>
  API version: 0.57<br>
  Document version: 2025-01-09<br>
  Author: Anders Rundgren (<code>anders.rundgren.net@gmail.com</code>)
</body>
</html>